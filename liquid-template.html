<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="liquid-import.html">


<polymer-element name="liquid-template" attributes="data">
  <template>

  </template>

  <script>
    (function () {
      var templateCache = {};

      Polymer('liquid-template', {
        data: {},

        ready: function () {
          this.templateCache = templateCache;          
        },

        domReady: function () {
          
        },

        render: function () {
          try {
            var tmpl = this.getCompiledTemplate();
            if (!tmpl) return;

            var html = tmpl.render(this.data);

            //this.shadowRoot.innerHTML = html;            

            // based on code from injectBoundHTML
            var template = document.createElement('template');
            template.innerHTML = html;
            var fragment = this.instanceTemplate(template);
            this.shadowRoot.textContent = '';
            this.shadowRoot.appendChild(fragment);

          } catch (ex) {
            var em = 'Exception caught liquid-template.render: ' + (ex.stack || ex);
            console.log(em);
            var emdiv = document.createElement('div');
            emdiv.innerHTML = em;
            this.shadowRoot.appendChild(emdiv);
          }
        },

        getCompiledTemplate: function () {
       
          var src = this.innerHTML.trim();
          if (!src) return null;

          // is content wrapped into <template> to allow nested components?
          if(src == "<template></template>") {
            var srctmpl = this.querySelector('template');
            src = srctmpl.instanceRef_.innerHTML.trim();
          }
          
          var cacheKey = "unknown";

          if (this.parentNode) {
            if (this.parentNode.id) cacheKey = this.parentNode.id;
            if (this.parentNode.host) cacheKey = this.parentNode.host.nodeName;
          }

          // return compiled template if already cached
          var cacheEntry = this.templateCache[cacheKey];
          if(cacheEntry) {            
            if(cacheEntry.template == src)  return cacheEntry.compiledTemplate;
          }

          var tmpl = Liquid.parse(src);
          
          // store compiled template in cache
          this.templateCache[cacheKey] = { template: src, compiledTemplate: tmpl }              
          
          return tmpl;
        },

        dataChanged: function () {

          this.render();

        }

      });

    })();
  </script>
</polymer-element>
